generator client {
  provider   = "prisma-client"
  output     = "./generated/prisma"
  engineType = "client"
  runtime    = "bun"
}

datasource db {
  provider = "mysql"
}

model User {
  id             Int         @id @default(autoincrement())
  userName       String      @unique
  email          String      @unique
  password       String
  sessionID      String      @unique
  Deck           Deck[]
  time_created   DateTime    @default(now())
  time_updated   DateTime    @default(now()) @updatedAt
  GameState      GameState   @default(IDLE)
  Characters     Character[]
  currentGameId  String?
  currentGame    Game?       @relation("CurrentGame", fields: [currentGameId], references: [id])
  gamesAsPlayer1 Game[]      @relation("Player1Games")
  gamesAsPlayer2 Game[]      @relation("Player2Games")
}

enum GameState {
  IDLE
  IN_BATTLE
  SEARCHING
}

model Deck {
  id             Int        @id @default(autoincrement())
  name           String
  userId         Int
  description    String?    @default("")
  time_created   DateTime   @default(now())
  time_updated   DateTime   @updatedAt
  user           User       @relation(fields: [userId], references: [id])
  deckCards      DeckCard[]
  gamesAsPlayer1 Game[]     @relation("Player1Deck")
  gamesAsPlayer2 Game[]     @relation("Player2Deck")
}

// Join table - links decks to cards with quantity
model DeckCard {
  id       Int @id @default(autoincrement())
  deckId   Int
  cardId   Int
  quantity Int @default(1)

  deck Deck     @relation(fields: [deckId], references: [id], onDelete: Cascade)
  card CardData @relation(fields: [cardId], references: [id])

  @@unique([deckId, cardId])
}

// Card definitions (master library)
model CardData {
  id          Int      @id @default(autoincrement())
  name        String   @unique
  type        CardType
  description String
  siege       Int
  bastion     Int
  spirit_cost Int
  health      Int

  time_created DateTime   @default(now())
  time_updated DateTime   @updatedAt
  deckCards    DeckCard[]
}

model Game {
  id          String      @id @default(uuid())
  player1Id   Int
  player2Id   Int?
  winnerId    Int?
  status      MatchStatus @default(WAITING)
  currentTurn Int         @default(1)

  player1DeckId Int?
  player2DeckId Int?
  player1       User  @relation("Player1Games", fields: [player1Id], references: [id])
  player2       User? @relation("Player2Games", fields: [player2Id], references: [id])
  player1Deck   Deck? @relation("Player1Deck", fields: [player1DeckId], references: [id])
  player2Deck   Deck? @relation("Player2Deck", fields: [player2DeckId], references: [id])

  player1Health    Int @default(20)
  player2Health    Int @default(20)
  player1MaxHealth Int @default(20)
  player2MaxHealth Int @default(20)

  time_created DateTime  @default(now())
  time_updated DateTime  @updatedAt
  usersInCurrentGame User[] @relation("CurrentGame")
}

enum MatchStatus {
  WAITING
  IN_PROGRESS
  FINISHED
  CANCELLED
}

model Character {
  id           Int      @id @default(autoincrement())
  name         String
  health       Int
  max_health   Int
  time_created DateTime @default(now())
  time_updated DateTime @updatedAt
  User         User?    @relation(fields: [userId], references: [id])
  userId       Int?
}

enum CardType {
  CREATURE
  SPELL
  AREA
}
